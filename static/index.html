<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>X Topic Top Tweets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#fff;
      --muted:#6b7280;
      --accent1:#0ea5a4;
      --accent2:#f59e0b;
      --accent3:#ef4444;
      --accent4:#3b82f6;
      --accent5:#7c3aed;
      --accent6:#10b981;
      --radius:12px;
    }
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); margin:0; padding:28px; color:#111;}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:12px;align-items:center}
    .topics{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:flex;align-items:center;padding:8px 10px;border-radius:999px;background:var(--card);box-shadow:0 2px 6px rgba(3,7,18,0.04);cursor:pointer;border:1px solid #eee}
    .chip input{margin-right:8px}
    .fetch-btn{background:#111;color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px;margin-top:18px}
    .section{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid #e6e9ee}
    .section h3{margin:0 0 6px 0;display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;padding:6px 8px;border-radius:8px;color:#fff}
    .list{margin-top:8px}
    .tweet{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.6));margin-bottom:8px;border:1px solid #f1f3f5}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .metrics{font-size:12px;color:var(--muted);display:flex;gap:10px;margin-top:8px}
    a{color:inherit;text-decoration:none}
    /* topic colors */
    .c-news{background:var(--accent1)}
    .c-finance{background:var(--accent2)}
    .c-stock{background:var(--accent3)}
    .c-markets{background:var(--accent4)}
    .c-economy{background:var(--accent5)}
    .c-regulation{background:var(--accent6)}
    /* responsive */
    @media (max-width:700px){.controls{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>X Topic Top Tweets</h1>
      <div class="small">Select topics below and click <strong>Retrieve</strong> to get top tweets (sorted by likes).</div>
    </div>
    <div class="controls">
      <div class="topics" id="topics">
        <label class="chip"><input type="checkbox" value="news" checked> #news</label>
        <label class="chip"><input type="checkbox" value="finance" checked> #finance</label>
        <label class="chip"><input type="checkbox" value="stock" checked> #stock</label>
        <label class="chip"><input type="checkbox" value="markets" > #markets</label>
        <label class="chip"><input type="checkbox" value="economy" > #economy</label>
        <label class="chip"><input type="checkbox" value="regulation" > #regulation</label>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Top
          <select id="top_n" style="margin-left:6px;padding:6px;border-radius:8px;border:1px solid #ddd">
            <option>5</option><option selected>10</option><option>12</option><option>15</option>
          </select>
        </label>
        <button class="fetch-btn" id="fetchBtn">Retrieve</button>
      </div>
    </div>
  </header>

  <div id="status" class="small" style="margin-bottom:10px"></div>

  <div class="grid" id="grid"></div>
</div>

<script>
const TOPIC_CLASSES = {
  news: 'c-news',
  finance: 'c-finance',
  stock: 'c-stock',
  markets: 'c-markets',
  economy: 'c-economy',
  regulation: 'c-regulation'
};

const fetchBtn = document.getElementById('fetchBtn');
const grid = document.getElementById('grid');
const status = document.getElementById('status');

async function fetchTweets(){
  const checked = Array.from(document.querySelectorAll('#topics input:checked')).map(i=>i.value);
  if(checked.length === 0){
    alert('Select at least one topic');
    return;
  }
  const topN = document.getElementById('top_n').value || '10';
  status.textContent = `Fetching ${topN} tweets for: ${checked.join(', ')} ‚Ä¶`;
  fetchBtn.disabled = true;
  grid.innerHTML = '';

  try{
    const q = encodeURIComponent(checked.join(','));
    const res = await fetch(`/api/latest-tweets?topics=${q}&top_n=${topN}`);
    if(!res.ok){
      const errText = await res.text();
      throw new Error(errText || res.statusText);
    }
    const j = await res.json();
    // j.topics -> map
    const topics = j.topics || {};
    status.textContent = `Retrieved.`;
    // render each topic
    for(const t of Object.keys(topics)){
      const data = topics[t];
      const sec = document.createElement('div');
      sec.className = 'section';
      const hdr = document.createElement('h3');
      const badge = document.createElement('span');
      badge.className = `badge ${TOPIC_CLASSES[t] || ''}`;
      badge.textContent = `#${t}`;
      hdr.appendChild(badge);
      const title = document.createElement('div');
      title.style.marginLeft = '10px';
      title.textContent = `Top ${data.count || 0}`;
      hdr.appendChild(title);
      sec.appendChild(hdr);

      const list = document.createElement('div');
      list.className = 'list';
      if(data.error){
        const e = document.createElement('div');
        e.style.color='darkred';
        e.textContent = 'Error: ' + data.error;
        list.appendChild(e);
      } else if((data.tweets||[]).length === 0){
        const n = document.createElement('div');
        n.textContent = 'No tweets found for this topic.';
        list.appendChild(n);
      } else {
        data.tweets.forEach(tweet => {
          const tw = document.createElement('div');
          tw.className = 'tweet';
          tw.innerHTML = `
            <div class="meta"><strong>${tweet.author_name || tweet.author_id}</strong> ¬∑ ${tweet.created_at ? new Date(tweet.created_at).toLocaleString() : ''}</div>
            <div>${tweet.text}</div>
            <div class="metrics">
              <div>‚ù§Ô∏è ${tweet.like_count}</div>
              <div>üîÅ ${tweet.retweet_count}</div>
              <div>üí¨ ${tweet.reply_count}</div>
              <div style="margin-left:auto"><a href="${tweet.url}" target="_blank">View on X</a></div>
            </div>
          `;
          list.appendChild(tw);
        });
      }
      sec.appendChild(list);
      grid.appendChild(sec);
    }
  } catch(err){
    console.error(err);
    alert('Error fetching tweets ‚Äî check server console. ' + err.message);
    status.textContent = 'Error fetching tweets';
  } finally {
    fetchBtn.disabled = false;
  }
}

fetchBtn.addEventListener('click', fetchTweets);
</script>
</body>
</html>
